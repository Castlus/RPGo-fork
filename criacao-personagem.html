<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Criar Personagem</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Nova Ficha de Personagem</h1>
        <input type="text" id="nome" placeholder="Nome do Personagem">
        
        <div class="status-box">
            <input type="number" id="hpMax" placeholder="Vida Máxima">
            <input type="number" id="ppMax" placeholder="Pontos de Poder Máximos">
        </div>

        <h3>Atributos</h3>
        <div class="grid-atributos" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" id="forca" placeholder="Força">
            <input type="number" id="destreza" placeholder="Destreza">
            <input type="number" id="constituicao" placeholder="Constituição">
            <input type="number" id="sabedoria" placeholder="Sabedoria">
            <input type="number" id="vontade" placeholder="Vontade">
            <input type="number" id="presenca" placeholder="Presença">
        </div>

        <button id="btnSalvarFicha" style="margin-top: 20px;">Criar Personagem</button>
    </div>

    <script type="module">
        import { supabase, apiPost } from './js/utils/api.js';

        // Proteção de rota: aguarda a sessão do Supabase ser restaurada.
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) {
            window.location.href = 'index.html';
        }

        const user = session.user;

        document.getElementById('btnSalvarFicha').addEventListener('click', async () => {
            const nome = document.getElementById('nome').value.trim();
            if (!nome) {
                alert('Dê um nome ao seu personagem!');
                return;
            }

            const hpMax = Number(document.getElementById('hpMax').value) || 0;
            const ppMax = Number(document.getElementById('ppMax').value) || 0;

            try {
                await apiPost('/users', {
                    nome,
                    hpMax,
                    ppMax,
                    forca:        Number(document.getElementById('forca').value)        || 0,
                    destreza:     Number(document.getElementById('destreza').value)     || 0,
                    constituicao: Number(document.getElementById('constituicao').value) || 0,
                    sabedoria:    Number(document.getElementById('sabedoria').value)    || 0,
                    vontade:      Number(document.getElementById('vontade').value)      || 0,
                    presenca:     Number(document.getElementById('presenca').value)     || 0
                });
                window.location.href = 'ficha.html';
            } catch (erro) {
                console.error('Erro ao salvar ficha:', erro);
                alert('Erro ao salvar personagem. Tente novamente.');
            }
        });
    </script>
</body>
</html>