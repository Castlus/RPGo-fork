# Componente Chat Tray

## üìã Descri√ß√£o
O componente **Chat Tray** √© uma bandeja de chat desliz√°vel e flutuante com integra√ß√£o Firebase. Oferece:
- ‚úÖ **Movimenta√ß√£o livre** com snap autom√°tico √†s bordas
- ‚úÖ **Detec√ß√£o de colis√£o** que impede sobreposi√ß√£o com o Dice Tray
- ‚úÖ **Chat compartilhado** ‚Äî todos os jogadores leem e escrevem no mesmo n√≥ do Firebase
- ‚úÖ **Listener √∫nico com unsubscribe** ‚Äî sem duplica√ß√£o de mensagens ao reabrir
- ‚úÖ **Mensagens ordenadas** por timestamp via `orderByChild()`
- ‚úÖ **Toggle** (abrir/fechar) com valida√ß√£o anti-conflito de drag vs. click

## üìÅ Estrutura de Arquivos
- `chat.html` - Template HTML com estrutura da bandeja
- `chat.js` - L√≥gica JavaScript com fun√ß√µes de chat, movimenta√ß√£o e colis√£o

## üîß Fun√ß√£o Exportada

### `iniciarChatTray(user, dbRefs)`
Inicializa a bandeja de chat com todas as funcionalidades.

**Par√¢metros:**

**1. `user` (Object) - Autentica√ß√£o**
```javascript
{
  uid: "userId123",           // String - ID √∫nico do usu√°rio
  displayName: "Jo√£o Silva",  // String - Nome para exibi√ß√£o
  email: "joao@email.com"     // String - Email (fallback)
}
```

**2. `dbRefs` (Object) - Refer√™ncias Firebase**
```javascript
{
  db: databaseInstance,       // Firebase Realtime Database
  ref: ref,                   // Fun√ß√£o ref() do Firebase
  onValue: onValue,           // Listener em tempo real
  push: push,                 // Adiciona dados
  remove: remove,             // Deleta dados (preparado)
  update: update              // Atualiza dados (preparado)
}
```

**Funcionamento Geral:**
1. ‚úÖ Carrega e valida elementos HTML necess√°rios
2. ‚úÖ Define estado inicial (grudado em baixo, fechado)
3. ‚úÖ Configura listeners de intera√ß√£o (clique, arraste)
4. ‚úÖ Implementa drag-and-drop com snap autom√°tico
5. ‚úÖ Detecta colis√£o com Dice Tray a cada movimento
6. ‚úÖ Permite enviar mensagens para Firebase
7. ‚úÖ Carrega e exibe hist√≥rico em tempo real
8. ‚úÖ Formata mensagens com timestamps e nomes

**Principais Recursos:**
- üéØ **Movimenta√ß√£o Livre**: Arraste o header para deslocar
- üìå **Snap Autom√°tico**: Gruda nas bordas quando pr√≥ximo (80px)
- üö´ **Colis√£o Inteligente**: Bloqueia movimento ao atingir Dice Tray
- üìç **3 Dock Points**: Posi√ß√µes de encaixe (bottom, left, right)
- üì± **Responsivo**: Movimento limitado aos limites da tela
- üîÑ **Toggle**: Clique no header para abrir/fechar
- üí¨ **Mensagens Reais**: Integra√ß√£o completa com Firebase
- ‚è∞ **Timestamps**: Cada mensagem registra data, hora e usu√°rio

---

## üé® Estados e Caracter√≠sticas

### Estados da Bandeja

#### Collapsed (Fechado)
- **Altura**: 45px (ou 45px lateral para dock-side)
- **Conte√∫do**: Apenas header com √≠cone e t√≠tulo
- **√çcone**: Chevron down (‚Üì)
- **Body**: Oculto (`display: none`)
- **Fun√ß√£o**: Minimiza a bandeja para economizar espa√ßo

#### Expanded (Aberto)
- **Altura**: Auto (com min-height 250px)
- **Conte√∫do**: Header + body com mensagens + input
- **√çcone**: Chevron up (‚Üë)
- **Body**: Vis√≠vel (`display: flex`)
- **Fun√ß√£o**: Mostra √°rea de chat completa para enviar/ler mensagens

#### Docked (Encaixado)
- **Bottom** (Padr√£o): Encostado na parte inferior, ocupa largura total
- **Left**: Encostado √† esquerda, altura vari√°vel, ocupando 45px de largura
- **Right**: Encostado √† direita, altura vari√°vel, ocupando 45px de largura
- **Transi√ß√£o**: Suave com easing `cubic-bezier(0.25, 0.8, 0.25, 1)` de 300ms

### Estrutura Interna

#### Header (`.chat-tray-header`)
- **Funcionalidade**: Clique para toggle (abrir/fechar)
- **Draggable**: Sim - use o mouse para arrastar
- **Elementos**:
  - √çcone chevron din√¢mico (muda conforme estado)
  - Texto "Chat"
  - Bot√£o close (X) para fechar/abrir
- **Cursor**: `grab` (repouso) / `grabbing` (arrastando)

#### Body (`.chat-tray-body`)
- **Flex Layout**: Vertical (column) com gap entre elementos
- **Elementos**:
  - `#chatMessages` - Container de mensagens com scroll vertical
  - `#chatInput` - Campo de texto para digitar mensagem
  - `#sendChatBtn` - Bot√£o para enviar (com √≠cone de papel-avi√£o)

### Armazenamento de Dados (Firebase)

**Localiza√ß√£o**: `sessions/mesa-principal/mensagens/{messageId}`

> üí° **SESSION_ID** (`'mesa-principal'`) est√° definido como constante no topo de `chat.js`.  
> Para suportar m√∫ltiplas mesas no futuro, basta tornar esse valor din√¢mico (ex: vindo de um seletor ou URL).

**Estrutura de cada mensagem**:
```json
{
  "uid": "userId123",
  "nome": "Jo√£o Silva",
  "mensagem": "Conte√∫do da mensagem",
  "timestamp": "2026-01-16T14:30:45.123Z"
}
```

**Caracter√≠sticas**:
- ‚úÖ Todos os jogadores escrevem e leem no **mesmo n√≥** ‚Äî chat √© compartilhado
- ‚úÖ Mensagens armazenadas com IDs √∫nicos (auto-gerados por `push()`)
- ‚úÖ Timestamps em formato ISO, **ordenadas por `orderByChild('timestamp')`**
- ‚úÖ Campo `uid` identifica o autor da mensagem
- ‚úÖ Campo `nome` para exibi√ß√£o leg√≠vel no chat

---

## üéÆ Sistema de Movimenta√ß√£o e Intera√ß√£o

### Drag-and-Drop Behavior

**Fluxo Completo de Movimento:**

1. **Mousedown no Header**
   - Ativa flag `isDragging = true`
   - Captura coordenadas iniciais (startX, startY)
   - Captura posi√ß√£o inicial do elemento (initialLeft, initialTop)
   - Muda cursor para `grabbing`

2. **Mousemove (enquanto isDragging)**
   - Calcula delta: `dx = e.clientX - startX`, `dy = e.clientY - startY`
   - Se movimento > 5px: ativa `hasMoved = true`
   - **Remove classes de dock** para liberar movimento
   - Aplica transi√ß√£o para anima√ß√£o suave
   - **Calcula nova posi√ß√£o**: `newLeft = initialLeft + dx`, `newTop = initialTop + dy`
   - **Limita √† viewport**: Garante que n√£o saia da tela
   - **Detecta colis√£o**: Verifica sobreposi√ß√£o com Dice Tray
   - Se sem colis√£o: **Aplica nova posi√ß√£o** ao elemento
   - Se com colis√£o: **Cancela movimento** (n√£o aplica posi√ß√£o)

3. **Mouseup**
   - Para o arraste: `isDragging = false`
   - Restaura cursor para `grab`
   - Se moveu (`hasMoved = true`): executa **snapToNearestEdge()**
   - Reseta `hasMoved` com delay de 50ms (evita conflito com toggle)

### Snap Autom√°tico √†s Bordas

**Fun√ß√£o**: `snapToNearestEdge()`

**L√≥gica de Snap** (verifica√ß√£o em ordem de preced√™ncia):

```javascript
// 1. VERIFICA PROXIMIDADE COM BORDAS
distLeft = rect.left                            // Dist√¢ncia √† esquerda
distRight = windowWidth - (rect.left + width)   // Dist√¢ncia √† direita
distBottom = windowHeight - (rect.top + height) // Dist√¢ncia ao fundo
snapThreshold = 80px                            // Limite de detec√ß√£o

// 2. EXECUTA SNAP (PRIMEIRA CONDI√á√ÉO VERDADEIRA)
if (distBottom < 80px)         ‚Üí Gruda em BAIXO
else if (distLeft < 80px)      ‚Üí Gruda √† ESQUERDA
else if (distRight < 80px)     ‚Üí Gruda √† DIREITA
else                            ‚Üí Fica FLUTUANDO
```

**Efeitos de cada Snap**:

| Snap | Classes | Estilos | Comportamento |
|------|---------|---------|---------------|
| **Bottom** | `dock-bottom` + `collapsed` | `bottom: 0; top: auto` | Recolhe e gruda na base, mant√©m posi√ß√£o X do usu√°rio |
| **Left** | `dock-side` + `collapsed` | `left: 0; right: auto` | Recolhe em coluna estreita √† esquerda |
| **Right** | `dock-side` + `collapsed` | `right: 0; left: auto` | Recolhe em coluna estreita √† direita |
| **Floating** | Nenhuma | left/top/bottom/right ajustados | Permanece em posi√ß√£o livre |

**Transi√ß√£o**: Todas as mudan√ßas usam `transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)`

### Detec√ß√£o de Colis√£o com Dice Tray

**Tipo**: AABB (Axis-Aligned Bounding Box)

**Fun√ß√£o**: `detectarColisao(newLeft, newTop, newWidth, newHeight)`

**Como Funciona**:
```javascript
// 1. Obt√©m posi√ß√£o e dimens√µes do Dice Tray
const diceRect = diceTray.getBoundingClientRect();
const diceLeft = diceRect.left;
const diceTop = diceRect.top;
const diceWidth = diceRect.width;
const diceHeight = diceRect.height;

// 2. Testa sobreposi√ß√£o (separa se est√£o distantes)
const overlap = !(
  newLeft + newWidth < diceLeft ||          // Chat √† ESQUERDA do Dice
  newLeft > diceLeft + diceWidth ||         // Chat √† DIREITA do Dice
  newTop + newHeight < diceTop ||           // Chat ACIMA do Dice
  newTop > diceTop + diceHeight             // Chat ABAIXO do Dice
);

// 3. Retorna true se h√° colis√£o
return overlap;
```

**Quando √© Verificado**: **Em cada evento de mousemove** enquanto arrasta

**Efeito da Colis√£o**: Se `detectarColisao()` retorna `true`, a posi√ß√£o **N√ÉO √© aplicada** (movimento √© cancelado)

### Toggle (Abrir/Fechar)

**Disparadores**:
- Clique no **header** (exceto no bot√£o close)
- Clique no **bot√£o close/chevron**

**Comportamento**:
```javascript
// S√≥ ativa toggle em cliques r√°pidos sem movimento (mesmo padr√£o do Dice Tray)
const clickDuration = Date.now() - dragStartTime;
if (hasMoved || clickDuration >= 200) return; // foi drag, n√£o click

// Se FECHADO (collapsed)
click ‚Üí Remove classe 'collapsed'
     ‚Üí Mostra body (display: flex)
     ‚Üí Cancela listener anterior (unsubscribe)
     ‚Üí Registra novo listener e carrega mensagens

// Se ABERTO
click ‚Üí Adiciona classe 'collapsed'
     ‚Üí Oculta body (display: none)
     // Listener permanece ‚Äî ser√° cancelado no pr√≥ximo open
```

---

## üìù Estrutura HTML

### Layout Completo
```html
<div id="chatTray" class="chat-tray dock-bottom collapsed">
    <!-- HEADER -->
    <div id="chatTrayHeader" class="chat-header">
        <span id="closeChatTray" class="chevron-icon">
            <!-- √çcone chevron din√¢mico -->
        </span>
        <span class="header-text">Chat</span>
    </div>

    <!-- BODY (OCULTO QUANDO COLLAPSED) -->
    <div id="chatTrayBody" class="chat-body" style="display: none;">
        <!-- √ÅREA DE MENSAGENS (COM SCROLL) -->
        <div id="chatMessages" class="chat-messages">
            <!-- Mensagens renderizadas aqui dinamicamente -->
        </div>

        <!-- INPUT & BOT√ÉO ENVIAR -->
        <div class="chat-input-container">
            <input 
                id="chatInput" 
                type="text" 
                placeholder="Digite sua mensagem..."
                class="chat-input"
            />
            <button id="sendChatBtn" class="send-btn">
                <!-- √çcone papel-avi√£o -->
            </button>
        </div>
    </div>
</div>
```

### Elementos Cr√≠ticos (IDs obrigat√≥rios)

| ID | Tipo | Fun√ß√£o |
|---|---|---|
| `chatTray` | div | Container principal (mov√≠vel) |
| `chatTrayHeader` | div | Header (draggable, toggle) |
| `closeChatTray` | span/button | √çcone chevron (toggle) |
| `chatTrayBody` | div | Container do chat (show/hide) |
| `chatMessages` | div | √Årea de mensagens (scroll√°vel) |
| `chatInput` | input | Campo de texto |
| `sendChatBtn` | button | Bot√£o enviar |

**Observa√ß√£o**: Se algum ID estiver faltando, o script registra erro no console mas continua funcionando (com 50 tentativas de retry em 100ms cada).

---

## üí¨ Sistema de Mensagens (Firebase)

### Fun√ß√µes Internas

#### 1. `enviarMensagem()`
Envia uma mensagem para Firebase.

**Fluxo**:
```javascript
1. Obt√©m texto do input: chatInput.value.trim()
2. Valida se n√£o est√° vazio
3. Cria timestamp: new Date().toISOString()
4. Constr√≥i refer√™ncia: ref(db, `sessions/${SESSION_ID}/mensagens`)
5. Push para Firebase com dados:
   {
     uid: user.uid,
     nome: user.displayName || user.email || 'An√¥nimo',
     mensagem: mensagem,
     timestamp: timestamp
   }
6. Se sucesso:
   - Limpa input
   - Devolve foco para input
   - Log de sucesso
7. Se erro:
   - Exibe alert com mensagem de erro
   - Log do erro no console
```

**Disparadores**:
- Click no `#sendChatBtn`
- Tecla `Enter` no `#chatInput`

**Valida√ß√µes**:
- ‚úÖ Mensagem n√£o vazia (trim)
- ‚úÖ Usu√°rio autenticado (uid dispon√≠vel)
- ‚úÖ Firebase conectado (db refer√™ncia v√°lida)

#### 2. `carregarMensagens()`
Carrega e exibe mensagens em tempo real do Firebase.

**Fluxo**:
```javascript
1. Cancela listener anterior (unsubscribeMensagens), se houver
2. Cria query ordenada: query(ref(db, `sessions/${SESSION_ID}/mensagens`), orderByChild('timestamp'))
3. Configura listener com onValue() ‚Äî guarda retorno em unsubscribeMensagens
4. Quando snapshot recebido:
   a. Valida se tem dados
   b. Se vazio: mostra "Nenhuma mensagem ainda..."
   c. Se tem dados: 
      - Itera sobre cada mensagem
      - Formata timestamp em hora local (PT-BR)
      - Determina se √© enviada (uid === user.uid)
      - Renderiza HTML com classe apropriada
   d. Auto-scroll para √∫ltima mensagem
4. Em caso de erro: Log no console
```

**Ativa√ß√£o**:
- Automaticamente quando chat √© **aberto** (clique no header)
- Mant√©m listener ativo enquanto chat est√° aberto
- Atualiza em **tempo real** quando novas mensagens chegam

### Comandos Especiais

#### Comando: `/limpar`
Apaga **todas as mensagens** do hist√≥rico de chat.

**Como usar**:
```
1. Digite: /limpar
2. Pressione Enter ou clique no bot√£o Enviar
3. Confirme na caixa de di√°logo (sim/n√£o)
4. Se confirmado: todas as mensagens s√£o deletadas do Firebase
```

**Funcionamento**:
```javascript
// 1. Detecta comando
if (mensagem.toLowerCase() === '/limpar') {
    // 2. Limpa input
    // 3. Chama remove() no Firebase
    // 4. Exibe confirma√ß√£o com dialog
}
```

**Fluxo**:
1. Usu√°rio digita `/limpar` e envia
2. Fun√ß√£o `enviarMensagem()` detecta o comando
3. **N√£o envia mensagem** (n√£o aparece no chat)
4. Exibe `confirm()`: "Tem certeza que deseja apagar TODAS as mensagens?"
5. Se clica "OK":
   - Executa `remove(ref(db, 'sessions/mesa-principal/mensagens'))`
   - Deleta a pasta inteira de mensagens do Firebase
   - Exibe: "‚úì Hist√≥rico de mensagens apagado com sucesso"
   - Chat fica vazio imediatamente
6. Se clica "Cancelar":
   - Nada acontece

**Caracter√≠sticas**:
- ‚úÖ Case-insensitive (`/limpar`, `/LIMPAR`, `/Limpar` funcionam)
- ‚úÖ N√£o envia o comando como mensagem
- ‚úÖ Requer confirma√ß√£o do usu√°rio
- ‚úÖ Apaga tudo de uma vez (sem volta)
- ‚úÖ Feedback visual com alert
- ‚ö†Ô∏è **Aviso**: A√ß√£o irrevers√≠vel!

**Exemplo de Uso**:
```
Usu√°rio: /limpar
[Dialog: Tem certeza que deseja apagar TODAS as mensagens? Sim/N√£o]
Usu√°rio: Clica "Sim"
[Chat limpo, alert: "‚úì Hist√≥rico de mensagens apagado com sucesso"]
```

### Renderiza√ß√£o de Mensagens

**Estrutura HTML de cada mensagem**:
```html
<div class="chat-message">
    <div class="chat-message-header">
        <span>14:30</span>
        <span class="chat-message-name">Voc√™</span>
    </div>
    <div class="chat-message-text">Conte√∫do da mensagem</div>
</div>
```

**Classes CSS Aplicadas**:
- `.chat-message` - Container da mensagem
- `.chat-message-header` - Header com hora e nome
- `.chat-message-text` - Conte√∫do da mensagem
- N√≠vel de significa√ß√£o: Cor da borda/fundo varia conforme remetente

**Formata√ß√£o de Timestamp**:
- Entrada: `"2026-01-16T14:30:45.123Z"` (ISO)
- Sa√≠da: `"14:30"` (formato PT-BR 24h)
- Fun√ß√£o: `new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })`

**Identifica√ß√£o de Autor**:
```javascript
const isSent = msg.uid === user.uid;
const nomeExibido = isSent ? 'Voc√™' : msg.nome;
```

---

## üîå Integra√ß√£o com Firebase

### Setup Necess√°rio

**Em seu arquivo de inicializa√ß√£o (ex: ficha.js)**:

```javascript
import { iniciarChatTray } from './js/components/chat/chat.js';
import { 
  getDatabase, ref, onValue, push, update, remove, query, orderByChild
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const db = getDatabase(app);

// IMPORTANTE: query e orderByChild s√£o necess√°rios para ordena√ß√£o de mensagens
const dbRefs = { db, ref, onValue, push, update, remove, query, orderByChild };

onAuthStateChanged(auth, async (user) => {
  if (user) {
    await carregarComponenteChat(); // injeta o HTML ANTES de chamar a fun√ß√£o
    iniciarChatTray(user, dbRefs);
  }
});
```

> ‚ö†Ô∏è O HTML do chat **deve ser injetado antes** de `iniciarChatTray()` ser chamado.
> O componente configura os listeners diretamente, sem retry por `setInterval`.

### Estrutura no Firebase Console

**Caminhos de dados**:
```
sessions/
  ‚îî‚îÄ‚îÄ mesa-principal/
      ‚îî‚îÄ‚îÄ mensagens/
          ‚îú‚îÄ‚îÄ -N123abc... (auto-ID do push)
          ‚îÇ   ‚îú‚îÄ‚îÄ uid: "userId123"
          ‚îÇ   ‚îú‚îÄ‚îÄ nome: "Jo√£o Silva"
          ‚îÇ   ‚îú‚îÄ‚îÄ mensagem: "Ol√°!"
          ‚îÇ   ‚îî‚îÄ‚îÄ timestamp: "2026-01-16T14:30:45.123Z"
          ‚îî‚îÄ‚îÄ -N123abd...
              ‚îî‚îÄ‚îÄ ...
```

> Todos os jogadores leem e escrevem em `sessions/mesa-principal/mensagens`.
> O `uid` dentro de cada mensagem identifica quem a enviou.

### Regras de Seguran√ßa Recomendadas

```json
{
  "rules": {
    "sessions": {
      "mesa-principal": {
        "mensagens": {
          ".read": "auth != null",
          ".write": "auth != null",
          "$messageId": {
            ".validate": "newData.hasChildren(['uid', 'nome', 'mensagem', 'timestamp']) && newData.child('uid').val() === auth.uid"
          }
        }
      }
    }
  }
}
```

**Funcionalidades**:
- ‚úÖ Cada usu√°rio v√™ apenas suas pr√≥prias mensagens
- ‚úÖ Apenas o propriet√°rio pode escrever
- ‚úÖ Admin pode ler todas (futuro)
- ‚úÖ Valida√ß√£o de estrutura de dados

---

## üöÄ Como Usar

### 1. Carregar o HTML do Chat

```javascript
async function carregarComponenteChat() {
    const container = document.getElementById('chatTrayContainer');
    const response = await fetch('./js/components/chat/chat.html');
    const html = await response.text();
    container.innerHTML = html;
}
```

### 2. Importar a Fun√ß√£o

```javascript
import { iniciarChatTray } from './js/components/chat/chat.js';
```

### 3. Configurar Firebase

```javascript
import { 
    getDatabase, ref, onValue, push, update, remove 
} from 'firebase/database';

const db = getDatabase(firebaseApp);
const dbRefs = {
    db: db,
    ref: ref,
    onValue: onValue,
    push: push,
    update: update,
    remove: remove
};
```

### 4. Inicializar no onAuthStateChanged

```javascript
firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
        // Carrega HTML
        await carregarComponenteChat();
        
        // Inicializa chat
        iniciarChatTray(user, dbRefs);
    }
});
```

### Exemplo Completo

```javascript
// ficha.js
import { iniciarChatTray } from './js/components/chat/chat.js';
import { getDatabase, ref, onValue, push, update, remove } from 'firebase/database';

const db = getDatabase();
const dbRefs = { db, ref, onValue, push, update, remove };

function carregarComponenteChat() {
    return fetch('./js/components/chat/chat.html')
        .then(r => r.text())
        .then(html => {
            document.getElementById('chatTrayContainer').innerHTML = html;
        });
}

firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
        console.log('Usu√°rio autenticado:', user.uid);
        
        // Carrega template HTML
        await carregarComponenteChat();
        
        // Inicializa com funcionalidades
        iniciarChatTray(user, dbRefs);
        
        console.log('Chat iniciado com sucesso');
    }
});
```

---

## üé® Estilos CSS

### Classes Principais

**Container**:
- `.chat-tray` - Container principal, flex column, posicionado absolute
- `.chat-tray.collapsed` - Estado fechado (altura 45px)
- `.chat-tray.expanded` - Estado aberto (altura auto, min 250px)
- `.chat-tray.dock-bottom` - Encaixado em baixo (bottom: 0)
- `.chat-tray.dock-side` - Encaixado lateral (width: 45px)

**Componentes**:
- `.chat-header` - Header draggable
- `.chat-body` - Body (flexbox column) com mensagens e input
- `.chat-messages` - Container de mensagens (overflow-y auto)
- `.chat-input-container` - Flex row com input + bot√£o
- `.chat-input` - Campo de texto
- `.send-btn` - Bot√£o enviar

**Mensagens**:
- `.chat-message` - Container individual da mensagem
- `.chat-message-header` - Header com hora e nome
- `.chat-message-text` - Conte√∫do da mensagem
- `.chat-message-name` - Nome do remetente

### Dimens√µes

| Elemento | Collapsed | Expanded |
|----------|-----------|----------|
| **Largura** | 45px (lado) / 320px (bottom) | 320px (sempre) |
| **Altura** | 45px | Auto (min 250px) |
| **Z-index** | 1000 | 1000 |

### Vari√°veis CSS Recomendadas

```css
:root {
    --primary: #6d4c41;              /* Cor do header */
    --bg-card: #3e2723;              /* Fundo da bandeja */
    --bg-page: #2c2c2c;              /* Fundo mensagens */
    --text-main: #ffffff;            /* Texto principal */
    --text-sec: #b0bec5;             /* Texto secund√°rio */
    --color-bonus: #4CAF50;          /* Mensagens pr√≥prias */
    --color-padrao: #2196F3;         /* Mensagens alheias */
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
    :root {
        --primary: #3e2723;
        --bg-card: #1e1e1e;
        --bg-page: #121212;
        --text-main: #ffffff;
        --text-sec: #9e9e9e;
    }
}
```

### Transi√ß√µes e Anima√ß√µes

**Snap Autom√°tico**:
```css
.chat-tray {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
```

**Smooth Scroll**:
```css
.chat-messages {
    scroll-behavior: smooth;
}
```

**Estados de Cursor**:
```css
.chat-header {
    cursor: grab;  /* Repouso */
}

.chat-header.dragging {
    cursor: grabbing;  /* Arrastando */
}
```

---

## ‚ö° Performance e Otimiza√ß√µes

### Listeners Ativos

**Durante Intera√ß√£o**:
- `mousedown` no header ‚Üí Inicia captura
- `mousemove` no document ‚Üí **Cont√≠nuo durante drag** (maior custo)
- `mouseup` no document ‚Üí Finaliza
- `click` no header ‚Üí Toggle
- `click` em sendBtn ‚Üí Enviar
- `keydown` no input ‚Üí Enviar (Enter)

**Cont√≠nuo**:
- `onValue()` do Firebase ‚Üí Listener de mensagens (recebe atualiza√ß√µes)

### Otimiza√ß√µes Implementadas

**1. Flag de Movimento**
```javascript
hasMoved = false;  // N√£o processa movimento at√© 5px
// Evita c√°lculos desnecess√°rios de colis√£o no in√≠cio
```

**2. Transi√ß√µes Seletivas**
```javascript
// Durante arraste: sem transi√ß√£o (performance)
chatTray.style.transition = 'none';

// Ap√≥s soltar: com transi√ß√£o suave
chatTray.style.transition = 'all 0.3s cubic-bezier(...)';
```

**3. Listener √önico com Unsubscribe**
```javascript
// O unsubscribe do listener √© armazenado e cancelado antes de registrar um novo.
// Isso evita m√∫ltiplos listeners ativos (que causariam renderiza√ß√£o duplicada de mensagens).
let unsubscribeMensagens = null;
// ... ao abrir:
if (unsubscribeMensagens) unsubscribeMensagens();
unsubscribeMensagens = onValue(mensagensQuery, callback);
```

**4. Valida√ß√£o Eficiente de Colis√£o**
```javascript
// AABB: O(1) - apenas 4 compara√ß√µes
const overlap = !(
    newLeft + newWidth < diceLeft ||
    newLeft > diceLeft + diceWidth ||
    newTop + newHeight < diceTop ||
    newTop > diceTop + diceHeight
);
```

**5. Snapshot Checking**
```javascript
if (!snapshot.exists()) return;  // Early exit se vazio
```

### Impacto Estimado

- **Drag-and-drop**: ~2-3ms por frame (60fps)
- **Detec√ß√£o de colis√£o**: <1ms por check
- **Renderiza√ß√£o de mensagens**: 5-10ms para 100 mensagens
- **Firebase listener**: Background, n√£o bloqueia UI

---

## üõ†Ô∏è Vari√°veis e Constantes Importantes

### No Escopo da Fun√ß√£o

```javascript
// ELEMENTOS
const chatTray = document.getElementById('chatTray');
const header = document.getElementById('chatTrayHeader');
const body = document.getElementById('chatTrayBody');
const closeBtn = document.getElementById('closeChatTray');
const diceTray = document.getElementById('diceTray');

// ESTADO DE ARRASTO
let isDragging = false;           // Se est√° arrastando agora
let startX, startY;               // Posi√ß√£o inicial do mouse
let initialLeft, initialTop;      // Posi√ß√£o inicial do elemento
let hasMoved = false;             // Se moveu mais de 5px
let dragStartTime = 0;            // Timestamp de in√≠cio

// CONSTANTES
const snapThreshold = 80;         // Dist√¢ncia para snap (px)
const safeMargin = 20;            // Margem m√≠nima na tela (px)
const setupRetryInterval = 100;   // Retry interval (ms)
const setupRetryMax = 50;         // M√°ximo de retries
```

### No Firebase

```javascript
// SESSION_ID compartilhado entre todos os jogadores
const SESSION_ID = 'mesa-principal'; // definido no topo de iniciarChatTray()

// Refer√™ncia das mensagens
`sessions/${SESSION_ID}/mensagens`

// Consulta ordenada por data (usada em carregarMensagens)
query(ref(db, `sessions/${SESSION_ID}/mensagens`), orderByChild('timestamp'))

// Estrutura de dados de cada mensagem
{
    uid: user.uid,               // identifica o autor
    nome: user.displayName || user.email || 'An√¥nimo',
    mensagem: string,            // texto da mensagem
    timestamp: ISO string        // usado para ordena√ß√£o
}

// Constantes de movimento
const snapThreshold = 80;  // dist√¢ncia para snap (px)
const safeMargin = 20;     // margem m√≠nima na tela (px)
```

---

## üîÑ Fluxo de Dados Completo

### 1Ô∏è‚É£ Inicializa√ß√£o
```
iniciarChatTray(user, dbRefs)
    ‚Üì
Carrega elementos do DOM
    ‚Üì
Define estado: dock-bottom + collapsed
    ‚Üì
Configura listeners:
  - mousedown (arraste)
  - mousemove (movimento)
  - mouseup (soltar)
  - click (toggle)
  - keydown (Enter no input)
    ‚Üì
Aguarda clique do usu√°rio
```

### 2‚É£ Envio de Mensagem
```
Usu√°rio digita + clica bot√£o / pressiona Enter
    ‚Üì
Valida: mensagem n√£o vazia
    ‚Üì
Cria timestamp ISO atual
    ‚Üì
Monta objeto com uid, nome, mensagem, timestamp
    ‚Üì
push(ref(db, 'sessions/mesa-principal/mensagens'), objeto)
    ‚Üì
Firebase armazena com ID √∫nico auto-gerado
    ‚Üì
Listener onValue() √© disparado
    ‚Üì
carregarMensagens() renderiza nova mensagem (j√° em ordem)
    ‚Üì
Auto-scroll para √∫ltima
    ‚Üì
Input limpo + foco restaurado
```

### 3‚É£ Carregamento de Mensagens
```
Chat aberto (clique no header)
    ‚Üì
carregarMensagens() chamado
    ‚Üì
Cancela listener anterior (unsubscribeMensagens)
    ‚Üì
Cria query ordenada por timestamp:
  query(ref(db, 'sessions/mesa-principal/mensagens'), orderByChild('timestamp'))
    ‚Üì
Registra novo onValue() ‚Üí guarda unsubscribe
    ‚Üì
Snapshot recebido:
  - Se vazio: mostra "Nenhuma mensagem ainda..."
  - Se tem dados: itera em ordem cronol√≥gica, formata, renderiza
    ‚Üì
Each mensagem:
  - Formata timestamp em hora local PT-BR
  - Determina se √© do usu√°rio (isSent = uid === user.uid)
  - Renderiza com nome exibido ("Voc√™" ou nome real)
    ‚Üì
Insere HTML em #chatMessages
    ‚Üì
Auto-scroll para √∫ltima mensagem
    ‚Üì
Mant√©m listener ativo para atualiza√ß√µes em tempo real
```

### 4Ô∏è‚É£ Movimento e Snap
```
Usu√°rio arrasta no header
    ‚Üì
mousedown ‚Üí isDragging = true, captura posi√ß√£o
    ‚Üì
mousemove ‚Üí calcula dx/dy
    ‚Üì
Se movimento > 5px ‚Üí hasMoved = true
    ‚Üì
A cada mousemove:
  - Remove classes dock
  - Calcula nova posi√ß√£o
  - Limita √† viewport
  - **Detecta colis√£o com diceTray**
  - Se sem colis√£o: aplica posi√ß√£o
  - Se com colis√£o: cancela movimento
    ‚Üì
mouseup ‚Üí isDragging = false
    ‚Üì
snapToNearestEdge():
  - Calcula dist√¢ncia √†s 3 bordas (left, right, bottom)
  - Encontra a mais pr√≥xima (threshold: 80px)
  - Aplica classe dock apropriada + collapsed
  - Anima com transition 300ms
    ‚Üì
Delay 50ms ‚Üí hasMoved = false (para pr√≥ximo toggle)
```

---

## ‚öôÔ∏è Como Adaptar e Customizar

### Customiza√ß√£o 1: Alterar Snap Threshold (dist√¢ncia para grudar)

**Arquivo**: `chat.js`, linha ~280

**Antes**:
```javascript
const snapThreshold = 80; // 80px
```

**Depois** (exemplo para 120px):
```javascript
const snapThreshold = 120; // 120px - mais "pegajoso"
```

**Efeito**: Quanto maior, mais longe da borda voc√™ pode estar para grudar.

### Customiza√ß√£o 2: Alterar Velocidade de Snap (transi√ß√£o)

**Arquivo**: `chat.js`, linhas ~179 e ~284

**Antes**:
```javascript
chatTray.style.transition = 'all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
```

**Depois** (exemplo: 500ms):
```javascript
chatTray.style.transition = 'all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1)';
```

**Efeito**: `0.3s` = r√°pido, `0.5s` = mais lento, `1s` = bem lento.

### Customiza√ß√£o 3: Desabilitar Detec√ß√£o de Colis√£o

**Arquivo**: `chat.js`, linha ~250

**Antes**:
```javascript
if (detectarColisao(newLeft, newTop, currentWidth, currentHeight)) {
    return; // N√£o aplica movimento
}
```

**Depois** (comment out):
```javascript
// if (detectarColisao(newLeft, newTop, currentWidth, currentHeight)) {
//     return; // N√£o aplica movimento
// }
```

**Efeito**: Chat pode sobrepor o Dice Tray.

### Customiza√ß√£o 4: Alterar Dimens√µes Padr√£o

**Arquivo**: `style.css`

**Antes**:
```css
.chat-tray {
    width: 320px;
    /* ... */
}

.chat-tray.collapsed {
    height: 45px;
}

.chat-tray:not(.collapsed) {
    height: 300px;
    min-height: 250px;
}
```

**Depois** (exemplo: 400px de largura):
```css
.chat-tray {
    width: 400px;  /* era 320px */
    /* ... */
}
```

### Customiza√ß√£o 5: Mensagens Autom√°ticas de Boas-vindas

**Arquivo**: `chat.js`, adicione ap√≥s `carregarMensagens()`

```javascript
function verificarPrimeiraVez() {
    const messagesRef = ref(db, `sessions/${SESSION_ID}/mensagens`);
    
    onValue(messagesRef, (snapshot) => {
        if (!snapshot.exists()) {
            // Primeira vez - sem mensagens
            // Voc√™ pode adicionar uma mensagem de boas-vindas autom√°tica
            console.log('Primeira vez do usu√°rio no chat');
        }
    }, { onlyOnce: true });
}
```

### Customiza√ß√£o 6: Notifica√ß√£o de Nova Mensagem

**Arquivo**: `chat.js`, dentro de `carregarMensagens()`

```javascript
let ultimaMensagemCount = 0;

onValue(messagesRef, (snapshot) => {
    if (!snapshot.exists()) return;
    
    const dados = snapshot.val();
    const countAtual = Object.keys(dados).length;
    
    if (ultimaMensagemCount < countAtual && countAtual > 0) {
        // Nova mensagem chegou!
        if (!document.hidden) {
            // S√≥ mostra se janela est√° focada
            console.log('üí¨ Nova mensagem!');
        }
    }
    
    ultimaMensagemCount = countAtual;
    // ... resto do c√≥digo
});
```

### Customiza√ß√£o 7: Persist√™ncia de Posi√ß√£o (LocalStorage)

**Arquivo**: `chat.js`, adicione esta fun√ß√£o

```javascript
function salvarPosicaoChat() {
    const rect = chatTray.getBoundingClientRect();
    const dados = {
        left: chatTray.style.left,
        top: chatTray.style.top,
        collapsed: chatTray.classList.contains('collapsed'),
        docked: chatTray.classList.contains('dock-bottom') ? 'bottom' :
                chatTray.classList.contains('dock-side') ? 'side' : 'floating'
    };
    localStorage.setItem('chatTrayPos_' + user.uid, JSON.stringify(dados));
}

function restaurarPosicaoChat() {
    const dados = JSON.parse(
        localStorage.getItem('chatTrayPos_' + user.uid) || 'null'
    );
    if (dados) {
        if (dados.collapsed) {
            chatTray.classList.add('collapsed');
            body.style.display = 'none';
        }
        if (dados.left) chatTray.style.left = dados.left;
        if (dados.top) chatTray.style.top = dados.top;
    }
}

// Chamar ao iniciar
setTimeout(() => restaurarPosicaoChat(), 500);

// Salvar em snapToNearestEdge() e mouseup
document.addEventListener('mouseup', () => {
    // ... c√≥digo existente
    setTimeout(salvarPosicaoChat, 350);
});
```

---

## üêõ Troubleshooting

| Problema | Causa | Solu√ß√£o |
|----------|-------|---------|
| **Chat n√£o aparece** | HTML n√£o carregou/elemento #chatTray n√£o existe | Verificar `fetch()` em carregarComponenteChat() e IDs no HTML |
| **Mensagens n√£o enviam** | Firebase n√£o conectado ou `dbRefs` inv√°lido | Verificar firebase-config.js e se `dbRefs` foi passado corretamente |
| **Mensagens n√£o carregam** | Listener n√£o ativado ou refer√™ncia incorreta | Confirmar que `carregarMensagens()` √© chamado ao abrir chat |
| **Colis√£o n√£o funciona** | Dice Tray oculto (`display: none`) | Verificar visibilidade do #diceTray, ajustar l√≥gica de detec√ß√£o |
| **Movimento travado** | Event listener bloqueado ou `isDragging` preso | Verificar se eventos mousemove/mouseup est√£o registrados |
| **Snap n√£o funciona** | Threshold muito alto ou classe dock n√£o removida | Reduzir snapThreshold, verificar CSS classes |
| **Z-index errado** | Conflito com modals/otros elementos | Aumentar z-index de 1000 para 8999 em style.css |
| **Input n√£o recebe texto** | Elemento #chatInput n√£o encontrado ou oculto | Verificar HTML, se input est√° dentro de #chatTrayBody |
| **√çcone chevron n√£o muda** | JavaScript n√£o atualizando HTML | Verificar se `#closeChatTray` existe e tem √≠cone renderizado |
| **Performance baixa em muitas mensagens** | Rendering lento com >500 mensagens | Implementar pagina√ß√£o ou virtualiza√ß√£o de mensagens |

---

## üìö Compara√ß√£o com Dice Tray

| Caracter√≠stica | Dice Tray | Chat Tray |
|---|---|---|
| **Movimenta√ß√£o** | ‚úÖ Livre | ‚úÖ Livre |
| **Snap √†s bordas** | ‚úÖ Sim (80px) | ‚úÖ Sim (80px) |
| **Colis√£o detectada** | ‚ùå N√£o | ‚úÖ Detecta Dice Tray |
| **Dock Points** | 3 (bottom, left, right) | 3 (bottom, left, right) |
| **Z-index** | 1000 | 1000 |
| **Toggle (abrir/fechar)** | ‚úÖ Sim | ‚úÖ Sim |
| **Dados Persistentes** | ‚ùå N√£o | ‚úÖ Firebase Realtime |
| **Mensagens em Tempo Real** | N/A | ‚úÖ Sim, via Firebase |
| **Timestamps** | N/A | ‚úÖ ISO format com hora local |
| **Controle de Usu√°rio** | N/A | ‚úÖ Identifica remetente |

---

## üîê Seguran√ßa e Boas Pr√°ticas

### Firebase Security Rules

**‚úÖ Recomendado**: Regras restritivas
```json
{
  "rules": {
    "chats": {
      "$uid": {
        "mensagens": {
          ".read": "auth.uid === $uid",
          ".write": "auth.uid === $uid",
          ".validate": "newData.hasChildren(['uid', 'nome', 'mensagem', 'timestamp'])"
        }
      }
    }
  }
}
```

**‚ùå Evitar**: Acesso p√∫blico
```json
{ "rules": { ".read": true, ".write": true } }  // NUNCA!
```

### Valida√ß√£o de Dados

**No Frontend**:
```javascript
// Sempre validar entrada
const mensagem = chatInput.value.trim();
if (!mensagem || mensagem.length === 0) return;
if (mensagem.length > 1000) {
    alert('Mensagem muito longa (m√°x 1000 caracteres)');
    return;
}
```

**No Backend (Firebase Rules)**:
```json
".validate": "newData.child('mensagem').val().length <= 1000"
```

---

## üöÄ Futuras Melhorias (Pacote B e al√©m)

1. **Anima√ß√£o de open/close** ‚Äî igualar ao Dice Tray (expans√£o animada com measuring de altura)
2. **Integra√ß√£o Dice Tray ‚Üí Chat** ‚Äî ao rolar dados, fazer `push` para o chat com `tipo: 'rolagem'`
3. **Badge de n√£o lidos** ‚Äî contador visual no header quando o chat est√° minimizado
4. **Sanitiza√ß√£o XSS** ‚Äî usar `textContent` ou DOMPurify para evitar inje√ß√£o de HTML via mensagens
5. **M√∫ltiplas mesas** ‚Äî tornar `SESSION_ID` din√¢mico (vindo de seletor ou URL)
6. **Suporte touch** ‚Äî adicionar `touchstart/touchmove/touchend` ao drag-and-drop
7. **Limite de hist√≥rico** ‚Äî usar `limitToLast(200)` na query para n√£o carregar todo o hist√≥rico

---

## Troubleshooting

| Problema             | Causa                    | Solu√ß√£o |
|----------            |-------                   |---------                                      |
| Chat n√£o aparece     | HTML n√£o carregou        | Verificar fetch em `carregarComponenteChat()` |
| Colis√£o n√£o funciona | Dice Tray oculto         | Verificar `display: none` do diceTray         |
| Movimento travado    | Event listener bloqueado | Verificar `isDragging` flag                   |
| Snap n√£o funciona    | Threshold muito alto     | Reduzir `snapThreshold` de 80px               |
| Z-index errado       | Conflito com outro modal | Aumentar z-index de 1000 para 8999            |

---

## Notas T√©cnicas

1. **AABB Collision**: Funciona para ret√¢ngulos alinhados aos eixos (n√£o rotacionados)
2. **getBoundingClientRect()**: Usa coordenadas da viewport, n√£o do document
3. **Snap Suave**: Usa `cubic-bezier(0.25, 0.8, 0.25, 1)` para anima√ß√£o
4. **Debouncing**: Usa `hasMoved` flag para evitar snap prematura
5. **Z-index 1000**: Abaixo de modals (9999) mas acima de conte√∫do normal
