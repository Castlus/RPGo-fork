// ─────────────────────────────────────────────────────────────────────────────
// Prisma Schema — RPGo
//
// SETUP SUPABASE REALTIME (faça no SQL Editor do Supabase após o migrate):
//   ALTER TABLE personagens REPLICA IDENTITY FULL;
//   ALTER TABLE itens        REPLICA IDENTITY FULL;
//   ALTER TABLE acoes        REPLICA IDENTITY FULL;
//   ALTER TABLE mensagens    REPLICA IDENTITY FULL;
// E adicione cada tabela na lista de publicações do Realtime no Supabase Dashboard.
// ─────────────────────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Espelha os UIDs do auth.users do Supabase — nunca gera ID próprio
model Personagem {
  id            String  @id
  nome          String
  nivel         Int     @default(1)
  hpAtual       Int     @default(0)  @map("hp_atual")
  hpMax         Int     @default(0)  @map("hp_max")
  ppAtual       Int     @default(0)  @map("pp_atual")
  ppMax         Int     @default(0)  @map("pp_max")
  cargaMaxima   Float   @default(20) @map("carga_maxima")
  ultimaRolagem String? @map("ultima_rolagem")

  // Atributos desnormalizados para simplicidade de queries
  forca         Int     @default(0)
  destreza      Int     @default(0)
  constituicao  Int     @default(0)
  sabedoria     Int     @default(0)
  vontade       Int     @default(0)
  presenca      Int     @default(0)

  itens  Item[]
  acoes  Acao[]

  @@map("personagens")
}

model Item {
  id            String     @id @default(uuid())
  personagemId  String     @map("personagem_id")
  personagem    Personagem @relation(fields: [personagemId], references: [id], onDelete: Cascade)

  nome          String
  peso          Float      @default(0)
  tipo          String     @default("comum")
  tags          String?
  descricao     String?
  dano          String?
  modificador   Int        @default(0)
  ca            Int        @default(0)
  penalidadeDes Int        @default(0) @map("penalidade_des")
  equipado      Boolean    @default(false)
  favorito      Boolean    @default(false)

  @@map("itens")
}

model Acao {
  id            String     @id @default(uuid())
  personagemId  String     @map("personagem_id")
  personagem    Personagem @relation(fields: [personagemId], references: [id], onDelete: Cascade)

  nome          String
  descricao     String
  tipo          String
  tag           String?

  @@map("acoes")
}

model Mensagem {
  id          String   @id @default(uuid())
  sessionId   String   @map("session_id")
  uid         String
  nome        String
  mensagem    String?
  timestamp   DateTime @default(now())
  tipo        String?  @default("texto")
  total       Int?
  modificador Int?
  detalhes    Json?

  @@index([sessionId, timestamp])
  @@map("mensagens")
}
